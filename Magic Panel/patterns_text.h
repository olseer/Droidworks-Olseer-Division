/*
 * Text Scrolling Patterns
 * Fonts and text scrolling functionality
 */

#ifndef PATTERNS_TEXT_H
#define PATTERNS_TEXT_H

#include "led_control.h"
#include "patterns_shapes.h" // Notwendig f√ºr die drawSprite-Hilfsfunktion

extern PanelState panelState;
extern bool patternActive;

namespace Text {
  
  unsigned long scrollBuffer[14] = {0};
  
  const unsigned char font5x7[] PROGMEM = {
    // Space (0x20)
    B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, 3,
    // ! (0x21)
    B01000000, B01000000, B01000000, B01000000, B01000000, B00000000, B01000000, 2,
    // " (0x22)
    B10100000, B10100000, B10100000, B00000000, B00000000, B00000000, B00000000, 4,
    // # (0x23)
    B01010000, B01010000, B11111000, B01010000, B11111000, B01010000, B01010000, 6,
    // $ (0x24)
    B00100000, B01111000, B10100000, B01110000, B00101000, B11110000, B00100000, 6,
    // % (0x25)
    B11000000, B11001000, B00010000, B00100000, B01000000, B10011000, B00011000, 6,
    // & (0x26)
    B01100000, B10010000, B10100000, B01000000, B10101000, B10010000, B01101000, 6,
    // ' (0x27)
    B11000000, B01000000, B10000000, B00000000, B00000000, B00000000, B00000000, 3,
    // ( (0x28)
    B00100000, B01000000, B10000000, B10000000, B10000000, B01000000, B00100000, 4,
    // ) (0x29)
    B10000000, B01000000, B00100000, B00100000, B00100000, B01000000, B10000000, 4,
    // * (0x2A)
    B00000000, B00100000, B10101000, B01110000, B10101000, B00100000, B00000000, 6,
    // + (0x2B)
    B00000000, B00100000, B00100000, B11111000, B00100000, B00100000, B00000000, 6,
    // , (0x2C)
    B00000000, B00000000, B00000000, B00000000, B11000000, B01000000, B10000000, 3,
    // - (0x2D)
    B00000000, B00000000, B11111000, B00000000, B00000000, B00000000, B00000000, 6,
    // . (0x2E)
    B00000000, B00000000, B00000000, B00000000, B00000000, B11000000, B11000000, 3,
    // / (0x2F)
    B00000000, B00001000, B00010000, B00100000, B01000000, B10000000, B00000000, 6,
    // 0-9 (0x30-0x39)
    B01110000, B10001000, B10011000, B10101000, B11001000, B10001000, B01110000, 6,
    B01000000, B11000000, B01000000, B01000000, B01000000, B01000000, B11100000, 4,
    B01110000, B10001000, B00001000, B00010000, B00100000, B01000000, B11111000, 6,
    B11111000, B00010000, B00100000, B00010000, B00001000, B10001000, B01110000, 6,
    B00010000, B00110000, B01010000, B10010000, B11111000, B00010000, B00010000, 6,
    B11111000, B10000000, B11110000, B00001000, B00001000, B10001000, B01110000, 6,
    B00110000, B01000000, B10000000, B11110000, B10001000, B10001000, B01110000, 6,
    B11111000, B10001000, B00001000, B00010000, B00100000, B00100000, B00100000, 6,
    B01110000, B10001000, B10001000, B01110000, B10001000, B10001000, B01110000, 6,
    B01110000, B10001000, B10001000, B01111000, B00001000, B00010000, B01100000, 6,
    // : (0x3A)
    B00000000, B11000000, B11000000, B00000000, B11000000, B11000000, B00000000, 3,
    // ; (0x3B)
    B00000000, B11000000, B11000000, B00000000, B11000000, B01000000, B10000000, 3,
    // < (0x3C)
    B00010000, B00100000, B01000000, B10000000, B01000000, B00100000, B00010000, 5,
    // = (0x3D)
    B00000000, B00000000, B11111000, B00000000, B11111000, B00000000, B00000000, 6,
    // > (0x3E)
    B10000000, B01000000, B00100000, B00010000, B00100000, B01000000, B10000000, 5,
    // ? (0x3F)
    B01110000, B10001000, B00001000, B00010000, B00100000, B00000000, B00100000, 6,
    // @ (0x40)
    B01110000, B10001000, B00001000, B01101000, B10101000, B10101000, B01110000, 6,
    // A-Z (0x41-0x5A)
    B01110000, B10001000, B10001000, B10001000, B11111000, B10001000, B10001000, 6,
    B11110000, B10001000, B10001000, B11110000, B10001000, B10001000, B11110000, 6,
    B01110000, B10001000, B10000000, B10000000, B10000000, B10001000, B01110000, 6,
    B11100000, B10010000, B10001000, B10001000, B10001000, B10010000, B11100000, 6,
    B11111000, B10000000, B10000000, B11110000, B10000000, B10000000, B11111000, 6,
    B11111000, B10000000, B10000000, B11110000, B10000000, B10000000, B10000000, 6,
    B01110000, B10001000, B10000000, B10111000, B10001000, B10001000, B01111000, 6,
    B10001000, B10001000, B10001000, B11111000, B10001000, B10001000, B10001000, 6,
    B11100000, B01000000, B01000000, B01000000, B01000000, B01000000, B11100000, 4,
    B00111000, B00010000, B00010000, B00010000, B00010000, B10010000, B01100000, 6,
    B10001000, B10010000, B10100000, B11000000, B10100000, B10010000, B10001000, 6,
    B10000000, B10000000, B10000000, B10000000, B10000000, B10000000, B11111000, 6,
    B10001000, B11011000, B10101000, B10101000, B10001000, B10001000, B10001000, 6,
    B10001000, B10001000, B11001000, B10101000, B10011000, B10001000, B10001000, 6,
    B01110000, B10001000, B10001000, B10001000, B10001000, B10001000, B01110000, 6,
    B11110000, B10001000, B10001000, B11110000, B10000000, B10000000, B10000000, 6,
    B01110000, B10001000, B10001000, B10001000, B10101000, B10010000, B01101000, 6,
    B11110000, B10001000, B10001000, B11110000, B10100000, B10010000, B10001000, 6,
    B01111000, B10000000, B10000000, B01110000, B00001000, B00001000, B11110000, 6,
    B11111000, B00100000, B00100000, B00100000, B00100000, B00100000, B00100000, 6,
    B10001000, B10001000, B10001000, B10001000, B10001000, B10001000, B01110000, 6,
    B10001000, B10001000, B10001000, B10001000, B10001000, B01010000, B00100000, 6,
    B10001000, B10001000, B10001000, B10101000, B10101000, B10101000, B01010000, 6,
    B10001000, B10001000, B01010000, B00100000, B01010000, B10001000, B10001000, 6,
    B10001000, B10001000, B10001000, B01010000, B00100000, B00100000, B00100000, 6,
    B11111000, B00001000, B00010000, B00100000, B01000000, B10000000, B11111000, 6,
    // [ (0x5B) to ~ (0x7E)
    B11100000, B10000000, B10000000, B10000000, B10000000, B10000000, B11100000, 4,
    B00000000, B10000000, B01000000, B00100000, B00010000, B00001000, B00000000, 6,
    B11100000, B00100000, B00100000, B00100000, B00100000, B00100000, B11100000, 4,
    B00100000, B01010000, B10001000, B00000000, B00000000, B00000000, B00000000, 6,
    B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11111000, 6,
    B10000000, B01000000, B00100000, B00000000, B00000000, B00000000, B00000000, 4,
    // a-z (0x61-0x7A)
    B00000000, B00000000, B01110000, B00001000, B01111000, B10001000, B01111000, 6,
    B10000000, B10000000, B10110000, B11001000, B10001000, B10001000, B11110000, 6,
    B00000000, B00000000, B01110000, B10001000, B10000000, B10001000, B01110000, 6,
    B00001000, B00001000, B01101000, B10011000, B10001000, B10001000, B01111000, 6,
    B00000000, B00000000, B01110000, B10001000, B11111000, B10000000, B01110000, 6,
    B00110000, B01001000, B01000000, B11100000, B01000000, B01000000, B01000000, 6,
    B00000000, B01111000, B10001000, B10001000, B01111000, B00001000, B01110000, 6,
    B10000000, B10000000, B10110000, B11001000, B10001000, B10001000, B10001000, 6,
    B01000000, B00000000, B11000000, B01000000, B01000000, B01000000, B11100000, 4,
    B00010000, B00000000, B00110000, B00010000, B00010000, B10010000, B01100000, 5,
    B10000000, B10000000, B10010000, B10100000, B11000000, B10100000, B10010000, 5,
    B11000000, B01000000, B01000000, B01000000, B01000000, B01000000, B11100000, 4,
    B00000000, B00000000, B11010000, B10101000, B10101000, B10001000, B10001000, 6,
    B00000000, B00000000, B10110000, B11001000, B10001000, B10001000, B10001000, 6,
    B00000000, B00000000, B01110000, B10001000, B10001000, B10001000, B01110000, 6,
    B00000000, B00000000, B11110000, B10001000, B11110000, B10000000, B10000000, 6,
    B00000000, B00000000, B01101000, B10011000, B01111000, B00001000, B00001000, 6,
    B00000000, B00000000, B10110000, B11001000, B10000000, B10000000, B10000000, 6,
    B00000000, B00000000, B01110000, B10000000, B01110000, B00001000, B11110000, 6,
    B01000000, B01000000, B11100000, B01000000, B01000000, B01001000, B00110000, 6,
    B00000000, B00000000, B10001000, B10001000, B10001000, B10011000, B01101000, 6,
    B00000000, B00000000, B10001000, B10001000, B10001000, B01010000, B00100000, 6,
    B00000000, B00000000, B10001000, B10101000, B10101000, B10101000, B01010000, 6,
    B00000000, B00000000, B10001000, B01010000, B00100000, B01010000, B10001000, 6,
    B00000000, B00000000, B10001000, B10001000, B01111000, B00001000, B01110000, 6,
    B00000000, B00000000, B11111000, B00010000, B00100000, B01000000, B11111000, 6,
    // { | } ~ (0x7B-0x7E)
    B00100000, B01000000, B01000000, B10000000, B01000000, B01000000, B00100000, 4,
    B10000000, B10000000, B10000000, B10000000, B10000000, B10000000, B10000000, 2,
    B10000000, B01000000, B01000000, B00100000, B01000000, B01000000, B10000000, 4,
    B00000000, B00000000, B00000000, B01101000, B10010000, B00000000, B00000000, 6,
    // DEL (0x7F)
    B01100000, B10010000, B10010000, B01100000, B00000000, B00000000, B00000000, 5,
    // Smiley (0x80)
    B00000000, B01100000, B01100110, B00000000, B10000001, B01100110, B00011000, 5
  };
  
  const unsigned char aurebesh5x7[] PROGMEM = {
    // Space (0x20)
    B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, 3,
    // ! (0x21)
    B00000000, B01000000, B10000000, B01000000, B10000000, B00000000, B00000000, 3,
    // " (0x22)
    B00000000, B10100000, B11000000, B10000000, B00000000, B00000000, B00000000, 4,
    // # (0x23)
    B01010000, B01010000, B11111000, B01010000, B11111000, B01010000, B01010000, 6,
    // $ (0x24)
    B00000000, B01010000, B11111110, B01010100, B00001000, B00010000, B00000000, 7,
    // % (0x25)
    B11000000, B11001000, B00010000, B00100000, B01000000, B10011000, B00011000, 6,
    // & (0x26)
    B01100000, B10010000, B10100000, B01000000, B10101000, B10010000, B01101000, 6,
    // ' (0x27)
    B00000000, B11000000, B01000000, B01000000, B00000000, B00000000, B00000000, 3,
    // ( (0x28)
    B00000000, B01000000, B01000000, B11000000, B01000000, B01000000, B00000000, 3,
    // ) (0x29)
    B00000000, B10000000, B10000000, B11000000, B10000000, B10000000, B00000000, 3,
    // * (0x2A)
    B00000000, B00100000, B10101000, B01110000, B10101000, B00100000, B00000000, 6,
    // + (0x2B)
    B00000000, B00100000, B00100000, B11111000, B00100000, B00100000, B00000000, 6,
    // , (0x2C)
    B00000000, B00000000, B00000000, B00000000, B01000000, B01000000, B01000000, 3,
    // - (0x2D)
    B00000000, B01100000, B00000000, B00000000, B00000000, B00000000, B00000000, 4,
    // . (0x2E)
    B00000000, B00000000, B00000000, B00000000, B10100000, B10100000, B10100000, 4,
    // / (0x2F)
    B00000000, B01000000, B01000000, B10000000, B10000000, B00000000, B00000000, 3,
    // 0-9 (same as regular font)
    B01110000, B10001000, B10011000, B10101000, B11001000, B10001000, B01110000, 6,
    B01000000, B11000000, B01000000, B01000000, B01000000, B01000000, B11100000, 4,
    B01110000, B10001000, B00001000, B00010000, B00100000, B01000000, B11111000, 6,
    B11111000, B00010000, B00100000, B00010000, B00001000, B10001000, B01110000, 6,
    B00010000, B00110000, B01010000, B10010000, B11111000, B00010000, B00010000, 6,
    B11111000, B10000000, B11110000, B00001000, B00001000, B10001000, B01110000, 6,
    B00110000, B01000000, B10000000, B11110000, B10001000, B10001000, B01110000, 6,
    B11111000, B10001000, B00001000, B00010000, B00100000, B00100000, B00100000, 6,
    B01110000, B10001000, B10001000, B01110000, B10001000, B10001000, B01110000, 6,
    B01110000, B10001000, B10001000, B01111000, B00001000, B00010000, B01100000, 6,
    // : to @ (0x3A-0x40)
    B00000000, B00000000, B10000000, B01000000, B11100000, B00000000, B00000000, 4,
    B00000000, B10000000, B10000000, B10000000, B10000000, B10000000, B00000000, 3,
    B00010000, B00100000, B01000000, B10000000, B01000000, B00100000, B00010000, 5,
    B00000000, B00000000, B11111000, B00000000, B11111000, B00000000, B00000000, 6,
    B10000000, B01000000, B00100000, B00010000, B00100000, B01000000, B10000000, 5,
    B00000000, B11000000, B10100000, B00100000, B00100000, B01000000, B00000000, 5,
    B01110000, B10001000, B00001000, B01101000, B10101000, B10101000, B01110000, 6,
    // A-Z (Aurebesh characters)
    B00000000, B10000110, B11111000, B00000000, B11111000, B10000110, B00000000, 7,
    B00000000, B01111100, B10000010, B00111000, B10000010, B01111100, B00000000, 7,
    B00000000, B01000000, B01000000, B01010100, B01010100, B00000100, B00000100, 7,
    B00000000, B11111110, B00000100, B01111000, B00010000, B00100000, B01000000, 7,
    B00000000, B10001110, B10001100, B01010100, B01010100, B00100100, B00100100, 7,
    B00000000, B00000000, B00010010, B11111100, B10010000, B11111110, B00000000, 7,
    B00000000, B10111110, B10100010, B10000100, B10000100, B10001000, B11110000, 7,
    B00000000, B01111110, B00000000, B00111100, B00000000, B01111110, B00000000, 7,
    B00000000, B00100000, B01100000, B00100000, B00100000, B00100000, B00000000, 4,
    B00000000, B00000010, B00001100, B11111000, B00010000, B11100000, B00000000, 7,
    B00000000, B00000000, B11111100, B00000100, B00000100, B11111100, B00000000, 7,
    B00000000, B00010000, B00010000, B10010000, B01010000, B00110000, B00000000, 7,
    B00000000, B00000000, B00011100, B00100000, B01000000, B01111100, B00000000, 7,
    B00000000, B01001000, B10001000, B10010100, B10100001, B01000001, B00000000, 7,
    B00000000, B00111000, B01000100, B10000010, B10000010, B01111100, B00000000, 7,
    B00000000, B01101000, B10001000, B10001000, B10001000, B01111000, B00000000, 7,
    B00000000, B00000000, B01111100, B01000100, B01000000, B01110000, B00000000, 7,
    B00000000, B11111110, B00000100, B00001000, B00010000, B00100000, B01000000, 7,
    B00000000, B10000100, B01000100, B00100100, B00010100, B10001100, B01100100, 7,
    B00000000, B00010000, B00010000, B01010100, B00111000, B00010000, B00000000, 7,
    B00000000, B10011100, B10100100, B10000100, B10000100, B11111100, B00000000, 7,
    B00000000, B01000100, B00101000, B00010000, B00010000, B00010000, B00000000, 7,
    B00000000, B00000000, B01111110, B01000010, B01000010, B01111110, B00000000, 7,
    B00000000, B00000000, B00010000, B00101000, B01000100, B00111000, B00000000, 7,
    B00000000, B11100010, B10100010, B01000100, B00101000, B00010000, B00000000, 7,
    B00000000, B00000100, B00011100, B00100100, B10000100, B11111100, B00000000, 7,
    // [ to DEL (0x5B-0x7F) - same as regular font
    B11100000, B10000000, B10000000, B10000000, B10000000, B10000000, B11100000, 4,
    B00000000, B10000000, B01000000, B00100000, B00010000, B00001000, B00000000, 6,
    B11100000, B00100000, B00100000, B00100000, B00100000, B00100000, B11100000, 4,
    B00100000, B01010000, B10001000, B00000000, B00000000, B00000000, B00000000, 6,
    B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11111000, 6,
    B00000000, B11000000, B10000000, B10000000, B00000000, B00000000, B00000000, 3,
    // a-z lowercase
    B00000000, B00000000, B01110000, B00001000, B01111000, B10001000, B01111000, 6,
    B10000000, B10000000, B10110000, B11001000, B10001000, B10001000, B11110000, 6,
    B00000000, B00000000, B01110000, B10001000, B10000000, B10001000, B01110000, 6,
    B00001000, B00001000, B01101000, B10011000, B10001000, B10001000, B01111000, 6,
    B00000000, B00000000, B01110000, B10001000, B11111000, B10000000, B01110000, 6,
    B00110000, B01001000, B01000000, B11100000, B01000000, B01000000, B01000000, 6,
    B00000000, B01111000, B10001000, B10001000, B01111000, B00001000, B01110000, 6,
    B10000000, B10000000, B10110000, B11001000, B10001000, B10001000, B10001000, 6,
    B01000000, B00000000, B11000000, B01000000, B01000000, B01000000, B11100000, 4,
    B00010000, B00000000, B00110000, B00010000, B00010000, B10010000, B01100000, 5,
    B10000000, B10000000, B10010000, B10100000, B11000000, B10100000, B10010000, 5,
    B11000000, B01000000, B01000000, B01000000, B01000000, B01000000, B11100000, 4,
    B00000000, B00000000, B11010000, B10101000, B10101000, B10001000, B10001000, 6,
    B00000000, B00000000, B10110000, B11001000, B10001000, B10001000, B10001000, 6,
    B00000000, B00000000, B01110000, B10001000, B10001000, B10001000, B01110000, 6,
    B00000000, B00000000, B11110000, B10001000, B11110000, B10000000, B10000000, 6,
    B00000000, B00000000, B01101000, B10011000, B01111000, B00001000, B00001000, 6,
    B00000000, B00000000, B10110000, B11001000, B10000000, B10000000, B10000000, 6,
    B00000000, B00000000, B01110000, B10000000, B01110000, B00001000, B11110000, 6,
    B01000000, B01000000, B11100000, B01000000, B01000000, B01001000, B00110000, 6,
    B00000000, B00000000, B10001000, B10001000, B10001000, B10011000, B01101000, 6,
    B00000000, B00000000, B10001000, B10001000, B10001000, B01010000, B00100000, 6,
    B00000000, B00000000, B10001000, B10101000, B10101000, B10101000, B01010000, 6,
    B00000000, B00000000, B10001000, B01010000, B00100000, B01010000, B10001000, 6,
    B00000000, B00000000, B10001000, B10001000, B01111000, B00001000, B01110000, 6,
    B00000000, B00000000, B11111000, B00010000, B00100000, B01000000, B11111000, 6,
    // { | } ~ (0x7B-0x7E)
    B00100000, B01000000, B01000000, B10000000, B01000000, B01000000, B00100000, 4,
    B10000000, B10000000, B10000000, B10000000, B10000000, B10000000, B10000000, 2,
    B10000000, B01000000, B01000000, B00100000, B01000000, B01000000, B10000000, 4,
    B00000000, B00000000, B00000000, B01101000, B10010000, B00000000, B00000000, 6,
    // DEL (0x7F)
    B01100000, B10010000, B10010000, B01100000, B00000000, B00000000, B00000000, 5,
    // Smiley (0x80)
    B00000000, B01100000, B01100110, B00000000, B10000001, B01100110, B00011000, 5
  };
  
  const unsigned char testMessage[] PROGMEM = "THIS IS A TEST MESSAGE. MAGIC PANEL V3.0!";
  const unsigned char aurebeshTest[] PROGMEM = " AUREBESH TEST. CAN YOU READ THIS? ";
  
  // Forward declarations
  void loadCharacter(int ascii, int fontType);
  void rotateBuffer();
  void displayBuffer();
  int loadCharacterToBuffer(int ascii, int fontType);

  void scrollMessage(const unsigned char* message, int fontType) {
    int counter = 0;
    char myChar;
    do {
      yield();
      myChar = pgm_read_byte_near(message + counter);
      if (myChar != 0) {
        loadCharacter(myChar, fontType);
      }
      counter++;
    } while (myChar != 0);
  }
  
  void loadCharacter(int ascii, int fontType) {
    if (ascii < 0x20 || ascii > 0x80) return;
    const unsigned char* fontPtr = (fontType == 1) ? font5x7 : aurebesh5x7;
    int charIndex = (ascii - 0x20) * 8;
    for (int a = 0; a < 7; a++) {
      scrollBuffer[a * 2] |= pgm_read_byte_near(fontPtr + charIndex + a);
    }
    byte count = pgm_read_byte_near(fontPtr + charIndex + 7);
    for (byte x = 0; x < count; x++) {
      yield(); // Watchdog-Fix
      rotateBuffer();
      displayBuffer();
      long dynamicDelay = map(panelState.animationSpeed, 1, 100, 150, 10);
      delay(dynamicDelay);
    }
  }
  
  void rotateBuffer() {
    for (int a = 0; a < 7; a++) {
      unsigned long x = scrollBuffer[a * 2];
      byte b = bitRead(x, 31);
      x <<= 1;
      scrollBuffer[a * 2] = x;
      x = scrollBuffer[a * 2 + 1];
      x <<= 1;
      bitWrite(x, 0, b);
      scrollBuffer[a * 2 + 1] = x;
    }
  }
  
  void displayBuffer() {
    CRGB color = LedControl::getCurrentColor();
    for (int a = 0; a < 7; a++) {
      LedControl::setRow(a, scrollBuffer[a * 2 + 1], color);
    }
    LedControl::updatePanel();
  }
  
  void clearBuffer() {
    for (int i = 0; i < 14; i++) {
      scrollBuffer[i] = 0;
    }
  }
  
  void scrollCustomText(String text, int fontType) {
    clearBuffer();
    text.toUpperCase();
    for (unsigned int i = 0; i < text.length(); i++) {
      yield();
      loadCharacter(text.charAt(i), fontType);
    }
    for (int i = 0; i < 8; i++) {
      yield();
      rotateBuffer();
      displayBuffer();
      long dynamicDelay = map(panelState.animationSpeed, 1, 100, 150, 10);
      delay(dynamicDelay);
    }
  }

  int loadCharacterToBuffer(int ascii, int fontType) {
    if (ascii < 0x20 || ascii > 0x80) return 0;
    const unsigned char* fontPtr = (fontType == 1) ? font5x7 : aurebesh5x7;
    int charIndex = (ascii - 0x20) * 8;
    for (int a = 0; a < 7; a++) {
      scrollBuffer[a * 2] |= pgm_read_byte_near(fontPtr + charIndex + a);
    }
    return pgm_read_byte_near(fontPtr + charIndex + 7);
  }

  void scrollRainbowText(String text, int fontType) {
      clearBuffer();
      text.toUpperCase();
      static uint8_t hue = 0;
      long dynamicDelay = map(panelState.animationSpeed, 1, 100, 150, 10);

      for (unsigned int i = 0; i < text.length(); i++) {
          int charWidth = loadCharacterToBuffer(text.charAt(i), fontType);
          for (int j = 0; j < charWidth; j++) {
              yield(); // Watchdog-Fix in der innersten Schleife
              rotateBuffer();
              LedControl::clearPanel();
              for (int y = 0; y < 7; y++) {
                  for (int x = 0; x < 8; x++) {
                      if ((scrollBuffer[y * 2 + 1] >> (7-x)) & 1) {
                          LedControl::setPixel(x, y, CHSV(hue + (x * 16), 255, 255));
                      }
                  }
              }
              LedControl::updatePanel();
              hue += 3;
              delay(dynamicDelay);
          }
      }
      for (int i=0; i<8; i++) {
        yield();
        rotateBuffer();
        LedControl::clearPanel();
        for (int y = 0; y < 7; y++) {
            for (int x = 0; x < 8; x++) {
                if ((scrollBuffer[y * 2 + 1] >> (7-x)) & 1) {
                    LedControl::setPixel(x, y, CHSV(hue + (x * 16), 255, 255));
                }
            }
        }
        LedControl::updatePanel();
        hue += 3;
        delay(dynamicDelay);
      }
  }

  void bouncingText(String text, int fontType) {
    CRGB color = LedControl::getCurrentColor();
    text.toUpperCase();
    for(unsigned int i=0; i<text.length(); i++) {
      yield();
      char c = text.charAt(i);
      if (c == ' ') { delay(200); continue; }
      if (c < 0x20 || c > 0x80) continue;
      
      const unsigned char* fontPtr = (fontType == 1) ? font5x7 : aurebesh5x7;
      int charIndex = (c - 0x20) * 8;
      uint8_t char_data[8] = {0};
      for(int j=0; j<8; j++) { char_data[j] = pgm_read_byte_near(fontPtr + charIndex + j); }
      
      for(int y=-7; y<=0; y++) { LedControl::clearPanel(); Shapes::drawSprite(0, y, char_data, color); LedControl::updatePanel(); delay(30); }
      LedControl::clearPanel(); Shapes::drawSprite(0, -1, char_data, color); LedControl::updatePanel(); delay(60);
      LedControl::clearPanel(); Shapes::drawSprite(0, 0, char_data, color); LedControl::updatePanel();
      delay(800);
    }
  }
}

void runTextPattern(int patternId) {
  switch (patternId) {
    case 97:
      Text::clearBuffer();
      Text::scrollMessage(Text::testMessage, 1);
      LedControl::clearPanel();
      break;
    case 98:
      Text::clearBuffer();
      Text::scrollMessage(Text::aurebeshTest, 2);
      LedControl::clearPanel();
      break;
    case 80: 
      Text::bouncingText("BOUNCE", panelState.useAurebesh ? 2:1); 
      break;
  }
}

#endif // PATTERNS_TEXT_H